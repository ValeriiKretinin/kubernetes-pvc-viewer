name: Release

on:
  push:
    tags: [ 'v*' ]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Package Helm chart
        run: |
          mkdir -p dist
          VERSION=${GITHUB_REF_NAME#v}
          helm dependency build helm/pvc-viewer || true
          helm package helm/pvc-viewer --version ${VERSION} --app-version ${VERSION} -d dist

      - name: Install git-cliff
        run: |
          set -euo pipefail
          CLIFF_VERSION=1.4.0
          curl -sSL -o git-cliff.tar.gz https://github.com/orhun/git-cliff/releases/download/v${CLIFF_VERSION}/git-cliff-${CLIFF_VERSION}-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf git-cliff.tar.gz git-cliff
          chmod +x git-cliff
          sudo mv git-cliff /usr/local/bin/git-cliff
      - name: Generate CHANGELOG.md (git-cliff)
        env:
          TAG: ${{ github.ref_name }}
        run: git-cliff --config .git-cliff.toml --tag "${TAG}" --output CHANGELOG.md
      - name: Commit CHANGELOG.md
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md || true
          git commit -m "docs(changelog): update for ${GITHUB_REF_NAME}" || echo "no changes"
          git push || true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: dist/*.tgz
